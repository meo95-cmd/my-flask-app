<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Task Manager Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="p-4">
    <div class="container">
        <h1 class="mb-4">üìã Qu·∫£n l√Ω c√¥ng vi·ªác nh√≥m</h1>

        <!-- Dashboard -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="alert alert-info">T·ªïng s·ªë c√¥ng vi·ªác: <strong id="totalTask">0</strong></div>
            </div>
            <div class="col-md-9">
                <canvas id="summaryChart" height="100"></canvas>
            </div>
        </div>

        <!-- L·ªçc d·ªØ li·ªáu -->
        <div class="row mb-4">
            <div class="col-md-3">
                <label>L·ªçc theo ng∆∞·ªùi ph·ª• tr√°ch:</label>
                <input type="text" id="filterPerson" class="form-control" placeholder="Nh·∫≠p t√™n...">
            </div>
            <div class="col-md-3">
                <label>L·ªçc theo m·ª©c ƒë·ªô ∆∞u ti√™n:</label>
                <select id="filterPriority" class="form-select">
                    <option value="">-- T·∫•t c·∫£ --</option>
                    <option value="th·∫•p">th·∫•p</option>
                    <option value="trung b√¨nh">trung b√¨nh</option>
                    <option value="cao">cao</option>
                </select>
            </div>
            <div class="col-md-3">
                <label>L·ªçc theo ng√†y:</label>
                <input type="date" id="filterDate" class="form-control">
            </div>
            <div class="col-md-3">
                <label>L·ªçc theo th√°ng:</label>
                <input type="month" id="filterMonth" class="form-control">
            </div>
        </div>

        <!-- N√∫t xu·∫•t CSV -->
        <a href="/export" class="btn btn-outline-primary mb-3">üì• T·∫£i v·ªÅ Excel (.csv)</a>

        <!-- Bi·ªÉu ƒë·ªì theo ng√†y -->
        <canvas id="taskChart" class="mb-4" height="100"></canvas>

        <!-- Form nh·∫≠p m·ªõi -->
        <form id="taskForm">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Ng√†y</th>
                        <th>Thi·∫øt b·ªã</th>
                        <th>V·∫•n ƒë·ªÅ</th>
                        <th>Nguy√™n nh√¢n</th>
                        <th>ƒê·ªëi s√°ch</th>
                        <th>Ph·ª• tr√°ch</th>
                        <th>∆Øu ti√™n</th>
                        <th>Comment</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="number" name="no" required class="form-control" /></td>
                        <td><input type="date" name="date" required class="form-control" /></td>
                        <td><input type="text" name="device" required class="form-control" /></td>
                        <td><input type="text" name="problem" required class="form-control" /></td>
                        <td><input type="text" name="cause" required class="form-control" /></td>
                        <td><input type="text" name="solution" required class="form-control" /></td>
                        <td><input type="text" name="person" required class="form-control" /></td>
                        <td>
                            <select name="priority" required class="form-select">
                                <option value="th·∫•p">th·∫•p</option>
                                <option value="trung b√¨nh">trung b√¨nh</option>
                                <option value="cao">cao</option>
                            </select>
                        </td>
                        <td><textarea name="comment" required class="form-control"></textarea></td>
                    </tr>
                </tbody>
            </table>
            <button type="submit" class="btn btn-success">‚ûï Th√™m c√¥ng vi·ªác</button>
        </form>

        <!-- B·∫£ng d·ªØ li·ªáu -->
        <hr>
        <table id="taskTable" class="table table-striped table-bordered mt-3">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Ng√†y</th>
                    <th>Thi·∫øt b·ªã</th>
                    <th>V·∫•n ƒë·ªÅ</th>
                    <th>Nguy√™n nh√¢n</th>
                    <th>ƒê·ªëi s√°ch</th>
                    <th>Ph·ª• tr√°ch</th>
                    <th>∆Øu ti√™n</th>
                    <th>Comment</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Modal ch·ªânh s·ª≠a -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="editForm">
                    <div class="modal-header">
                        <h5 class="modal-title">‚úèÔ∏è Ch·ªânh s·ª≠a c√¥ng vi·ªác</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body row g-3 p-3">
                        <input type="hidden" id="editNo">
                        <div class="col-md-6"><label>Ng√†y</label><input type="date" id="editDate" class="form-control" required></div>
                        <div class="col-md-6"><label>Thi·∫øt b·ªã</label><input type="text" id="editDevice" class="form-control" required></div>
                        <div class="col-md-6"><label>V·∫•n ƒë·ªÅ</label><input type="text" id="editProblem" class="form-control" required></div>
                        <div class="col-md-6"><label>Nguy√™n nh√¢n</label><input type="text" id="editCause" class="form-control" required></div>
                        <div class="col-md-6"><label>ƒê·ªëi s√°ch</label><input type="text" id="editSolution" class="form-control" required></div>
                        <div class="col-md-6"><label>Ph·ª• tr√°ch</label><input type="text" id="editPerson" class="form-control" required></div>
                        <div class="col-md-6">
                            <label>∆Øu ti√™n</label>
                            <select id="editPriority" class="form-select" required>
                                <option value="th·∫•p">th·∫•p</option>
                                <option value="trung b√¨nh">trung b√¨nh</option>
                                <option value="cao">cao</option>
                            </select>
                        </div>
                        <div class="col-12"><label>Comment</label><textarea id="editComment" class="form-control" required></textarea></div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‚ùå H·ªßy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Script x·ª≠ l√Ω -->
    <script>
        const form = document.getElementById("taskForm");
        const editForm = document.getElementById("editForm");
        const taskTableBody = document.querySelector("#taskTable tbody");
        let currentEditNo;

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const task = {
                No: formData.get("no"),
                date: formData.get("date"),
                device: formData.get("device"),
                problem: formData.get("problem"),
                cause: formData.get("cause"),
                solution: formData.get("solution"),
                person: formData.get("person"),
                priority: formData.get("priority"),
                comment: formData.get("comment")
            };
            await fetch("/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(task)
            });
            form.reset();
            loadTasks();
        });

        taskTableBody.addEventListener("click", (e) => {
            const row = e.target.closest("tr");
            const taskNo = row.children[0].textContent;

            if (e.target.classList.contains("deleteBtn")) {
                fetch(`/delete/${taskNo}`, { method: "DELETE" }).then(loadTasks);
            }

            if (e.target.classList.contains("editBtn")) {
                currentEditNo = taskNo;
                document.getElementById("editNo").value = taskNo;
                document.getElementById("editDate").value = row.children[1].textContent;
                document.getElementById("editDevice").value = row.children[2].textContent;
                document.getElementById("editProblem").value = row.children[3].textContent;
                document.getElementById("editCause").value = row.children[4].textContent;
                document.getElementById("editSolution").value = row.children[5].textContent;
                document.getElementById("editPerson").value = row.children[6].textContent;
                document.getElementById("editPriority").value = row.children[7].textContent;
                document.getElementById("editComment").value = row.children[8].textContent;
                const modal = new bootstrap.Modal(document.getElementById("editModal"));
                modal.show();
            }
        });

        editForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const editedTask = {
                date: document.getElementById("editDate").value,
                device: document.getElementById("editDevice").value,
                problem: document.getElementById("editProblem").value,
                cause: document.getElementById("editCause").value,
                solution: document.getElementById("editSolution").value,
                person: document.getElementById("editPerson").value,
                priority: document.getElementById("editPriority").value,
                comment: document.getElementById("editComment").value
            };
            await fetch(`/edit/${currentEditNo}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(editedTask)
            });
            const modal = bootstrap.Modal.getInstance(document.getElementById("editModal"));
            modal.hide();
            loadTasks();
        });

        async function loadTasks() {
            const res = await fetch("/tasks");
            const tasks = await res.json();
            taskTableBody.innerHTML = "";
            tasks.forEach(task => {
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td>${task.No}</td>
                  <td>${task.date}</td>
                  <td>${task.device}</td>
                  <td>${task.problem}</td>
                  <td>${task.cause}</td>
                  <td>${task.solution}</td>
                  <td>${task.person}</td>
                  <td>${task.priority}</td>
                  <td>${task.comment}</td>
                  <td>
                    <button class="btn btn-warning btn-sm editBtn">‚úèÔ∏è</button>
                    <button class="btn btn-danger btn-sm deleteBtn">üóëÔ∏è</button>
                  </td>
                `;
                taskTableBody.appendChild(row);
            });
        }

        loadTasks();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
